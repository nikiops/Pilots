<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TgWork - –ë–∏—Ä–∂–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding-bottom: 70px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: #0d1117;
            min-height: 100vh;
        }

        .top-bar {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #58a6ff;
        }

        .search-box {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 12px;
            color: #c9d1d9;
            font-size: 13px;
        }

        .content {
            padding: 16px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #58a6ff;
            margin-bottom: 4px;
        }

        .card-desc {
            font-size: 13px;
            color: #c9d1d9;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6e7681;
        }

        .price-badge {
            background: #238636;
            color: #aaffc9;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #238636;
            color: #aaffc9;
        }

        .btn-primary:active {
            background: #2ea043;
        }

        .btn-secondary {
            background: #30363d;
            color: #c9d1d9;
        }

        .btn-secondary:active {
            background: #464f58;
        }

        .btn-danger {
            background: #da3633;
            color: #fff;
        }

        .btn-small {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #c9d1d9;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-tag {
            background: #30363d;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tag.active {
            background: #58a6ff;
            color: #0d1117;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #6e7681;
            text-transform: uppercase;
            margin: 20px 0 12px 0;
            padding-top: 16px;
            border-top: 1px solid #30363d;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #161b22;
            border-top: 1px solid #30363d;
            display: flex;
            justify-content: space-around;
            max-width: 600px;
            margin: 0 auto;
            z-index: 200;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            gap: 4px;
            cursor: pointer;
            border: none;
            background: none;
            color: #6e7681;
            font-size: 11px;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: #58a6ff;
        }

        .nav-icon {
            font-size: 24px;
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #30363d;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .user-info h2 {
            font-size: 16px;
            color: #c9d1d9;
            margin-bottom: 4px;
        }

        .user-info p {
            font-size: 13px;
            color: #6e7681;
        }

        .empty-state {
            text-align: center;
            padding: 40px 16px;
            color: #6e7681;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .divider {
            height: 1px;
            background: #30363d;
            margin: 12px 0;
        }

        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #30363d;
            background: #0d1117;
            color: #c9d1d9;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            border-color: #58a6ff;
            background: #0d1117;
            color: #58a6ff;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #30363d;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: #161b22;
            max-width: 600px;
            margin: 20px auto;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #c9d1d9;
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #6e7681;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #6e7681;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
        }

        .menu-dropdown {
            position: absolute;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            top: 30px;
            right: 0;
            min-width: 200px;
            z-index: 500;
            display: none;
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-item {
            padding: 10px 16px;
            border-bottom: 1px solid #30363d;
            cursor: pointer;
            font-size: 13px;
            color: #c9d1d9;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #30363d;
        }

        .menu-item.danger {
            color: #da3633;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card-menu {
            position: relative;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            gap: 20px;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #30363d;
            border-top: 4px solid #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #c9d1d9;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="app-container">
        <div class="top-bar">
            <div class="logo">üíº TgWork</div>
            <input type="text" class="search-box" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
        </div>

        <div class="content">
            <!-- LOGIN -->
            <div id="loginPage" class="page active">
                <div style="text-align: center; padding: 40px 0 20px 0;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üíº</div>
                    <h1 style="font-size: 28px; margin-bottom: 8px; color: #c9d1d9;">TgWork</h1>
                    <p style="color: #6e7681; font-size: 14px; margin-bottom: 40px;">–ë–∏—Ä–∂–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–∞</p>
                </div>

                <form id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="emailLogin" placeholder="user@example.com" required>
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="passwordLogin" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" required>
                    </div>
                    <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                </form>

                <div style="text-align: center; margin-top: 16px;">
                    <button type="button" class="btn btn-secondary" onclick="switchPage('registerPage')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="recoverPassword()">üîë –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
                </div>
            </div>

            <!-- REGISTER -->
            <div id="registerPage" class="page">
                <div style="margin-bottom: 20px;">
                    <h2 style="color: #c9d1d9; font-size: 20px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                </div>

                <form id="registerForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="emailReg" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label>–ò–º—è</label>
                        <input type="text" id="nameReg" placeholder="–í–∞—à–µ –∏–º—è" required>
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="passwordReg" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞" required>
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" id="passwordRegConfirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ" required>
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="switchPage('loginPage')">–ù–∞–∑–∞–¥</button>
                </form>
            </div>

            <!-- HOME -->
            <div id="homePage" class="page">
                <div class="user-header" id="userHeader"></div>
                <div id="homeContent"></div>
            </div>

            <!-- MARKETPLACE (–ó–ê–ö–ê–ó–´/–£–°–õ–£–ì–ò) -->
            <div id="marketplacePage" class="page">
                <div style="margin-bottom: 16px;">
                    <h2 style="color: #c9d1d9; font-size: 16px; margin-bottom: 8px;" id="marketplaceTitle">–ë–∏—Ä–∂–∞</h2>
                    <div class="filter-bar" id="categoryFilter"></div>
                </div>
                <div id="marketplaceList"></div>
            </div>

            <!-- MY SERVICES (–î–õ–Ø –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø) -->
            <div id="myServicesPage" class="page">
                <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                    <h2 style="flex: 1; color: #c9d1d9; font-size: 16px;">–ú–æ–∏ —É—Å–ª—É–≥–∏</h2>
                    <button class="btn btn-primary btn-small" onclick="switchPage('createServicePage')">‚ûï</button>
                </div>
                <div id="myServicesList"></div>
            </div>

            <!-- CREATE SERVICE (–î–õ–Ø –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø) -->
            <div id="createServicePage" class="page">
                <h2 style="color: #c9d1d9; font-size: 18px; margin-bottom: 16px;">–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞</h2>
                <form id="createServiceForm">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="serviceName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" required>
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="serviceDesc" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="serviceCategory" required></select>
                    </div>
                    <div class="form-group">
                        <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type="number" id="servicePrice" placeholder="500" required min="1">
                    </div>
                    <div class="form-group">
                        <label>–î–Ω–µ–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</label>
                        <input type="number" id="serviceDays" placeholder="3" required min="1">
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="switchPage('myServicesPage')">–û—Ç–º–µ–Ω–∞</button>
                </form>
            </div>

            <!-- MY ORDERS (–î–õ–Ø –ó–ê–ö–ê–ó–ß–ò–ö–ê) -->
            <div id="myOrdersPage" class="page">
                <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                    <h2 style="flex: 1; color: #c9d1d9; font-size: 16px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                    <button class="btn btn-primary btn-small" onclick="switchPage('createOrderPage')">‚ûï</button>
                </div>
                <div id="myOrdersList"></div>
            </div>

            <!-- CREATE ORDER (–î–õ–Ø –ó–ê–ö–ê–ó–ß–ò–ö–ê) -->
            <div id="createOrderPage" class="page">
                <h2 style="color: #c9d1d9; font-size: 18px; margin-bottom: 16px;">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
                <form id="createOrderForm">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="orderName" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã" required>
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="orderDesc" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="orderCategory" required></select>
                    </div>
                    <div class="form-group">
                        <label>–ë—é–¥–∂–µ—Ç (‚ÇΩ)</label>
                        <input type="number" id="orderBudget" placeholder="1000" required min="1">
                    </div>
                    <div class="form-group">
                        <label>–î–Ω–µ–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</label>
                        <input type="number" id="orderDeadline" placeholder="5" required min="1">
                    </div>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
                    <button type="button" class="btn btn-secondary" onclick="switchPage('myOrdersPage')">–û—Ç–º–µ–Ω–∞</button>
                </form>
            </div>

            <!-- PROFILE -->
            <div id="profilePage" class="page">
                <div style="margin-bottom: 16px;">
                    <h2 style="color: #c9d1d9; font-size: 16px;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                </div>
                <div id="profileContent"></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchPage('homePage'); updateNav(this)">
            <div class="nav-icon">üè†</div>
            <div>Home</div>
        </button>
        <button class="nav-item" id="navMarketplace" onclick="switchPage('marketplacePage'); updateNav(this)">
            <div class="nav-icon">üõçÔ∏è</div>
            <div>–ë–∏—Ä–∂–∞</div>
        </button>
        <button class="nav-item" id="navMyWork" onclick="updateNav(this)">
            <div class="nav-icon">üì¶</div>
            <div id="navMyWorkLabel">–£—Å–ª—É–≥–∏</div>
        </button>
        <button class="nav-item" onclick="switchPage('profilePage'); updateNav(this)">
            <div class="nav-icon">üë§</div>
            <div>–ü—Ä–æ—Ñ–∏–ª—å</div>
        </button>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
                <button class="modal-close" onclick="closeOrderDetail()">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailBody">
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const API_URL = '/api';
        const STORAGE_KEY = 'tgwork_user';
        
        let currentUser = null;
        let selectedCategory = null;
        
        async function loadAllOrdersFromServer() {
            try {
                console.log('üîó Loading orders from server...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç
                
                const response = await fetch('/api/users/all', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                console.log('‚úÖ Orders response:', response.status);
                if (response.ok) {
                    const allUsers = await response.json();
                    let allOrders = [];
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π
                    Object.values(allUsers).forEach(user => {
                        if (user.orders && Array.isArray(user.orders)) {
                            allOrders.push(...user.orders);
                        }
                    });
                    
                    console.log('üì¶ Orders loaded:', allOrders.length);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ –∫–µ—à
                    localStorage.setItem('all_orders', JSON.stringify(allOrders));
                    return allOrders;
                } else {
                    console.error('‚ùå Server error:', response.status);
                }
            } catch (e) {
                console.error('‚ùå Orders load failed:', e.message);
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
            try {
                const stored = localStorage.getItem('all_orders');
                console.log('üì¶ Using cached orders:', stored ? JSON.parse(stored).length : 0);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error('‚ùå Cache read error:', e.message);
                return [];
            }
        }

        async function loadAllServicesFromServer() {
            try {
                console.log('üîó Loading services from server...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç
                
                const response = await fetch('/api/users/all', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                console.log('‚úÖ Services response:', response.status);
                if (response.ok) {
                    const allUsers = await response.json();
                    let allServices = [];
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π
                    Object.values(allUsers).forEach(user => {
                        if (user.services && Array.isArray(user.services)) {
                            allServices.push(...user.services);
                        }
                    });
                    
                    console.log('üì¶ Services loaded:', allServices.length);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ –∫–µ—à
                    localStorage.setItem('all_services', JSON.stringify(allServices));
                    return allServices;
                } else {
                    console.error('‚ùå Server error:', response.status);
                }
            } catch (e) {
                console.error('‚ùå Services load failed:', e.message);
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
            try {
                const stored = localStorage.getItem('all_services');
                console.log('üì¶ Using cached services:', stored ? JSON.parse(stored).length : 0);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error('‚ùå Cache read error:', e.message);
                return [];
            }
        }

        const CATEGORIES = [
            { id: 'design', name: 'üé® –î–∏–∑–∞–π–Ω' },
            { id: 'dev', name: 'üíª –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞' },
            { id: 'writing', name: '‚úçÔ∏è –ö–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥' },
            { id: 'marketing', name: 'üìä –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥' },
            { id: 'seo', name: 'üîç SEO' },
            { id: 'translate', name: 'üåê –ü–µ—Ä–µ–≤–æ–¥—ã' },
            { id: 'video', name: 'üé¨ –í–∏–¥–µ–æ' },
            { id: 'music', name: 'üéµ –ú—É–∑—ã–∫–∞' }
        ];

        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            
            if (pageName === 'homePage' && currentUser) displayHome();
            if (pageName === 'marketplacePage' && currentUser) displayMarketplace();
            if (pageName === 'myServicesPage' && currentUser) displayMyServices();
            if (pageName === 'myOrdersPage' && currentUser) displayMyOrders();
            if (pageName === 'profilePage' && currentUser) displayProfile();
        }

        function updateNav(btn) {
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function loadUserFromServer(email) {
            email = email.toLowerCase();
            try {
                console.log('üîó Fetching user:', email);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç
                
                const response = await fetch(`${API_URL}/users/${encodeURIComponent(email)}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                console.log('‚úÖ Response status:', response.status);
                if (response.ok) {
                    currentUser = await response.json();
                    console.log('‚úÖ User loaded:', currentUser.email);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({email: currentUser.email}));
                    
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –∏ —É—Å–ª—É–≥–∏ —Å localStorage
                    if (currentUser.orders && currentUser.orders.length > 0) {
                        let allOrders = [];
                        try {
                            const stored = localStorage.getItem('all_orders');
                            allOrders = stored ? JSON.parse(stored) : [];
                        } catch (e) {}
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
                        currentUser.orders.forEach(order => {
                            if (!allOrders.find(o => o.id === order.id)) {
                                allOrders.push(order);
                            }
                        });
                        localStorage.setItem('all_orders', JSON.stringify(allOrders));
                    }
                    
                    if (currentUser.services && currentUser.services.length > 0) {
                        let allServices = [];
                        try {
                            const stored = localStorage.getItem('all_services');
                            allServices = stored ? JSON.parse(stored) : [];
                        } catch (e) {}
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —É—Å–ª—É–≥–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
                        currentUser.services.forEach(service => {
                            if (!allServices.find(s => s.id === service.id)) {
                                allServices.push(service);
                            }
                        });
                        localStorage.setItem('all_services', JSON.stringify(allServices));
                    }
                    
                    return true;
                } else {
                    console.error('‚ùå Server error:', response.status);
                }
            } catch (e) {
                console.error('‚ùå Load error:', e.message);
            }
            return false;
        }

        async function saveUser(userData) {
            userData.email = userData.email.toLowerCase();
            try {
                console.log('üíæ Saving user:', userData.email);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${API_URL}/users/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(userData),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    console.log('‚úÖ User saved');
                    currentUser = userData;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({email: userData.email}));
                    return true;
                } else {
                    console.error('‚ùå Save failed:', response.status);
                }
            } catch (e) {
                console.error('‚ùå Save error:', e.message);
            }
            return false;
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailLogin').value.toLowerCase();
            const password = document.getElementById('passwordLogin').value;

            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
            const loaded = await loadUserFromServer(email);
            
            // –ï—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage
            if (!loaded) {
                try {
                    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ users_db.json —á–µ—Ä–µ–∑ API
                    const response = await fetch(`${API_URL}/users/${encodeURIComponent(email)}`);
                    if (response.ok) {
                        currentUser = await response.json();
                    } else {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                        return;
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    return;
                }
            }

            if (currentUser && currentUser.password === password) {
                switchPage('homePage');
                updateNav(document.querySelector('[onclick*="homePage"]'));
                displayHome();
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailReg').value.toLowerCase();
            const password = document.getElementById('passwordReg').value;
            const passwordConfirm = document.getElementById('passwordRegConfirm').value;
            const name = document.getElementById('nameReg').value;

            if (password.length < 4) {
                alert('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞');
                return;
            }
            if (password !== passwordConfirm) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }

            const userData = {
                email: email,
                password: password,
                name: name,
                accountType: 'freelancer',
                username: '',
                bio: '',
                rating: 0,
                reviews: 0,
                services: [],
                orders: [],
                telegram_id: null,
                created_at: new Date().toISOString()
            };

            const saved = await saveUser(userData);
            if (saved) {
                alert('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í—ã - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å');
                switchPage('homePage');
                displayHome();
            }
        });

        function displayHome() {
            const isFreelancer = currentUser.accountType === 'freelancer';
            const avatarChar = currentUser.name.charAt(0).toUpperCase();
            
            document.getElementById('userHeader').innerHTML = `
                <div class="avatar">${avatarChar}</div>
                <div class="user-info">
                    <h2>${currentUser.name}</h2>
                    <p>${isFreelancer ? 'üöÄ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å' : 'üíº –ó–∞–∫–∞–∑—á–∏–∫'}</p>
                </div>
            `;

            document.getElementById('navMyWorkLabel').textContent = isFreelancer ? '–£—Å–ª—É–≥–∏' : '–ó–∞–∫–∞–∑—ã';
            document.getElementById('navMyWork').onclick = () => {
                if (isFreelancer) {
                    switchPage('myServicesPage');
                } else {
                    switchPage('myOrdersPage');
                }
                updateNav(this);
            };

            if (isFreelancer) {
                document.getElementById('homeContent').innerHTML = `
                    <button class="btn btn-primary" onclick="switchPage('createServicePage')">‚ûï –°–æ–∑–¥–∞—Ç—å —É—Å–ª—É–≥—É</button>
                    <div class="section-title">–í–∞—à–∏ —É—Å–ª—É–≥–∏ (${currentUser.services?.length || 0})</div>
                    ${(currentUser.services || []).length ? 
                        (currentUser.services || []).slice(0, 3).map(s => `
                            <div class="card">
                                <div class="card-title">${s.name}</div>
                                <div class="card-desc">${s.description}</div>
                                <div class="card-footer">
                                    <span class="price-badge">${s.price}‚ÇΩ</span>
                                    <span>${s.days}–¥–Ω</span>
                                </div>
                            </div>
                        `).join('')
                        : '<div style="color: #6e7681; padding: 20px; text-align: center;">–ù–µ—Ç —É—Å–ª—É–≥</div>'
                    }
                `;
            } else {
                document.getElementById('homeContent').innerHTML = `
                    <button class="btn btn-primary" onclick="switchPage('createOrderPage')">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
                    <div class="section-title">–í–∞—à–∏ –∑–∞–∫–∞–∑—ã (${currentUser.orders?.length || 0})</div>
                    ${(currentUser.orders || []).length ?
                        (currentUser.orders || []).slice(0, 3).map(o => `
                            <div class="card">
                                <div class="card-title">${o.name}</div>
                                <div class="card-desc">${o.description}</div>
                                <div class="card-footer">
                                    <span class="price-badge">${o.budget}‚ÇΩ</span>
                                    <span>${o.deadline}–¥–Ω</span>
                                </div>
                            </div>
                        `).join('')
                        : '<div style="color: #6e7681; padding: 20px; text-align: center;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'
                    }
                `;
            }
        }

        async function displayMarketplace() {
            const isFreelancer = currentUser.accountType === 'freelancer';
            document.getElementById('marketplaceTitle').textContent = isFreelancer ? '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã' : '–£—Å–ª—É–≥–∏';
            
            document.getElementById('categoryFilter').innerHTML = CATEGORIES.map(cat => `
                <div class="filter-tag ${selectedCategory === cat.id ? 'active' : ''}" 
                     onclick="selectedCategory = '${cat.id}'; displayMarketplace()">
                    ${cat.name}
                </div>
            `).join('');

            if (isFreelancer) {
                // –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨ –≤–∏–¥–∏—Ç –∑–∞–∫–∞–∑—ã - –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
                const allOrders = await loadAllOrdersFromServer();

                const filtered = selectedCategory 
                    ? allOrders.filter(o => o.category === selectedCategory)
                    : allOrders;

                document.getElementById('marketplaceList').innerHTML = filtered.length ? 
                    filtered.map(o => `
                        <div class="card" style="cursor: pointer;" onclick="openOrderDetail(${o.id})">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">üìã ${o.name}</div>
                                    <div style="font-size: 12px; color: #6e7681; margin-bottom: 8px;">–æ—Ç ${o.ownerName}</div>
                                </div>
                                <div class="card-menu">
                                    <button class="menu-btn" onclick="toggleOrderMenu(event, ${o.id})">‚ãÆ</button>
                                    <div id="menu-${o.id}" class="menu-dropdown">
                                        <div class="menu-item" onclick="reportOrder(${o.id})">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-desc">${o.description.substring(0, 80)}...</div>
                            <div class="card-footer">
                                <span class="price-badge">${o.budget}‚ÇΩ</span>
                                <span>‚è±Ô∏è ${o.deadline}–¥–Ω</span>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="empty-state"><div class="empty-state-icon">üì≠</div>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
            } else {
                // –ó–ê–ö–ê–ó–ß–ò–ö –≤–∏–¥–∏—Ç —É—Å–ª—É–≥–∏
                let allServices = [];
            } else {
                // –ó–ê–ö–ê–ó–ß–ò–ö –≤–∏–¥–∏—Ç —É—Å–ª—É–≥–∏ - –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
                const allServices = await loadAllServicesFromServer();

                const filtered = selectedCategory 
                    ? allServices.filter(s => s.category === selectedCategory)
                    : allServices;

                document.getElementById('marketplaceList').innerHTML = filtered.length ?
                    filtered.map(s => `
                        <div class="card" style="cursor: pointer;" onclick="openServiceDetail(${s.id})">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">üíº ${s.name}</div>
                                    <div style="font-size: 12px; color: #6e7681; margin-bottom: 8px;">–æ—Ç ${s.ownerName}</div>
                                </div>
                                <div class="card-menu">
                                    <button class="menu-btn" onclick="toggleServiceMenu(event, ${s.id})">‚ãÆ</button>
                                    <div id="service-menu-${s.id}" class="menu-dropdown">
                                        <div class="menu-item" onclick="reportService(${s.id})">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-desc">${s.description.substring(0, 80)}...</div>
                            <div class="card-footer">
                                <span class="price-badge">${s.price}‚ÇΩ</span>
                                <span>‚è±Ô∏è ${s.days}–¥–Ω</span>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="empty-state"><div class="empty-state-icon">üì≠</div>–ù–µ—Ç —É—Å–ª—É–≥</div>';
            }
        }

        function displayMyServices() {
            document.getElementById('myServicesList').innerHTML = (currentUser.services || []).length ?
                (currentUser.services || []).map(s => `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${s.name}</div>
                            </div>
                            <div class="card-menu">
                                <button class="menu-btn" onclick="toggleMyServiceMenu(event, ${s.id})">‚ãÆ</button>
                                <div id="my-service-menu-${s.id}" class="menu-dropdown">
                                    <div class="menu-item danger" onclick="deleteMyService(${s.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-desc">${s.description}</div>
                        <div class="card-footer">
                            <span class="price-badge">${s.price}‚ÇΩ</span>
                            <span>${s.days}–¥–Ω</span>
                        </div>
                    </div>
                `).join('')
                : '<div class="empty-state"><div class="empty-state-icon">üì¶</div>–ù–µ—Ç —É—Å–ª—É–≥</div>';
        }

        function displayMyOrders() {
            document.getElementById('myOrdersList').innerHTML = (currentUser.orders || []).length ?
                (currentUser.orders || []).map(o => `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${o.name}</div>
                            </div>
                            <div class="card-menu">
                                <button class="menu-btn" onclick="toggleMyOrderMenu(event, ${o.id})">‚ãÆ</button>
                                <div id="my-order-menu-${o.id}" class="menu-dropdown">
                                    <div class="menu-item danger" onclick="deleteMyOrder(${o.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-desc">${o.description}</div>
                        <div class="card-footer">
                            <span class="price-badge">${o.budget}‚ÇΩ</span>
                            <span>${o.deadline}–¥–Ω</span>
                        </div>
                    </div>
                `).join('')
                : '<div class="empty-state"><div class="empty-state-icon">üìã</div>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
        }

        function displayProfile() {
            const isFreelancer = currentUser.accountType === 'freelancer';
            document.getElementById('profileContent').innerHTML = `
                <div class="card">
                    <div class="card-title">${currentUser.name}</div>
                    <div style="font-size: 12px; color: #6e7681; margin: 8px 0;">
                        ${isFreelancer ? 'üöÄ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å' : 'üíº –ó–∞–∫–∞–∑—á–∏–∫'}
                    </div>
                    <div class="divider"></div>
                    <div style="font-size: 13px; color: #c9d1d9; line-height: 2;">
                        <div class="stat-item">
                            <span>üìß Email</span>
                            <span>${currentUser.email}</span>
                        </div>
                        <div class="stat-item">
                            <span>‚≠ê –†–µ–π—Ç–∏–Ω–≥</span>
                            <span>${currentUser.rating.toFixed(1)} / 5 (${currentUser.reviews})</span>
                        </div>
                        ${isFreelancer ? `
                            <div class="stat-item">
                                <span>üì¶ –£—Å–ª—É–≥</span>
                                <span>${currentUser.services?.length || 0}</span>
                            </div>
                        ` : `
                            <div class="stat-item">
                                <span>üìã –ó–∞–∫–∞–∑–æ–≤</span>
                                <span>${currentUser.orders?.length || 0}</span>
                            </div>
                        `}
                    </div>
                </div>

                <div style="margin-top: 16px;">
                    <div class="section-title">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º</div>
                    <div class="mode-toggle">
                        <button class="mode-btn ${isFreelancer ? 'active' : ''}" onclick="switchMode('freelancer')">
                            üöÄ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                        </button>
                        <button class="mode-btn ${!isFreelancer ? 'active' : ''}" onclick="switchMode('client')">
                            üíº –ó–∞–∫–∞–∑—á–∏–∫
                        </button>
                    </div>
                </div>

                <button class="btn btn-secondary" style="margin-top: 16px;" onclick="clearAppCache()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à</button>
                <button class="btn btn-secondary" style="margin-top: 8px;" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
            `;
        }

        function switchMode(newMode) {
            currentUser.accountType = newMode;
            saveUser(currentUser);
            alert(`–í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –≤ —Ä–µ–∂–∏–º: ${newMode === 'freelancer' ? '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å' : '–ó–∞–∫–∞–∑—á–∏–∫'}`);
            displayProfile();
            displayHome();
        }

        document.getElementById('serviceCategory').innerHTML = CATEGORIES.map(c => 
            `<option value="${c.id}">${c.name}</option>`
        ).join('');

        document.getElementById('orderCategory').innerHTML = CATEGORIES.map(c => 
            `<option value="${c.id}">${c.name}</option>`
        ).join('');

        document.getElementById('createServiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const service = {
                id: Date.now(),
                name: document.getElementById('serviceName').value,
                description: document.getElementById('serviceDesc').value,
                category: document.getElementById('serviceCategory').value,
                price: parseInt(document.getElementById('servicePrice').value),
                days: parseInt(document.getElementById('serviceDays').value),
                ownerName: currentUser.name,
                ownerEmail: currentUser.email
            };

            if (!currentUser.services) currentUser.services = [];
            currentUser.services.push(service);

            let allServices = [];
            try {
                const stored = localStorage.getItem('all_services');
                allServices = stored ? JSON.parse(stored) : [];
            } catch (e) {}
            allServices.push(service);
            localStorage.setItem('all_services', JSON.stringify(allServices));

            const saved = await saveUser(currentUser);
            if (saved) {
                alert('–£—Å–ª—É–≥–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                document.getElementById('createServiceForm').reset();
                switchPage('myServicesPage');
                displayMyServices();
            }
        });

        document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const order = {
                id: Date.now(),
                name: document.getElementById('orderName').value,
                title: document.getElementById('orderName').value,
                description: document.getElementById('orderDesc').value,
                category: document.getElementById('orderCategory').value,
                budget: parseInt(document.getElementById('orderBudget').value),
                deadline: parseInt(document.getElementById('orderDeadline').value),
                ownerName: currentUser.name,
                ownerEmail: currentUser.email
            };

            if (!currentUser.orders) currentUser.orders = [];
            currentUser.orders.push(order);

            let allOrders = [];
            try {
                const stored = localStorage.getItem('all_orders');
                allOrders = stored ? JSON.parse(stored) : [];
            } catch (e) {}
            allOrders.push(order);
            localStorage.setItem('all_orders', JSON.stringify(allOrders));

            const saved = await saveUser(currentUser);
            if (saved) {
                alert('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!');
                document.getElementById('createOrderForm').reset();
                switchPage('myOrdersPage');
                displayMyOrders();
            }
        });

        function clearAppCache() {
            if (confirm('üßπ –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                // –û—á–∏—â–∞–µ–º localStorage
                localStorage.clear();
                // –û—á–∏—â–∞–µ–º sessionStorage
                sessionStorage.clear();
                
                alert('‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω!\n\n–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É...');
                location.reload();
            }
        }

        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                localStorage.removeItem(STORAGE_KEY);
                currentUser = null;
                switchPage('loginPage');
            }
        }

        // Modal functions
        function openOrderDetail(orderId) {
            let order = null;
            let allOrders = [];
            try {
                const stored = localStorage.getItem('all_orders');
                allOrders = stored ? JSON.parse(stored) : [];
            } catch (e) {}

            order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞: –µ—Å–ª–∏ ownerEmail —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º - —ç—Ç–æ –µ–≥–æ –∑–∞–∫–∞–∑
            const isOwner = order.ownerEmail && order.ownerEmail.toLowerCase() === currentUser.email.toLowerCase();
            const isFreelancer = currentUser.accountType === 'freelancer';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä –ò —ç—Ç–æ –ù–ï –µ–≥–æ –∑–∞–∫–∞–∑
            const canBid = isFreelancer && !isOwner;

            let detailHTML = `
                <div class="card">
                    <h3 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px;">${order.name}</h3>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                        <div style="color: #c9d1d9; font-size: 13px; line-height: 1.5;">${order.description}</div>
                    </div>

                    <div class="divider"></div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0;">
                        <div>
                            <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üí∞ –ë—é–¥–∂–µ—Ç</div>
                            <div style="color: #238636; font-weight: 600; font-size: 16px;">${order.budget} ‚ÇΩ</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üìÖ –î–µ–¥–ª–∞–π–Ω</div>
                            <div style="color: #c9d1d9; font-size: 14px;">${order.deadline} –¥–Ω.</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                        <div style="color: #c9d1d9; font-size: 13px;">${getCategoryName(order.category)}</div>
                    </div>

                    <div class="divider"></div>

                    <div style="margin: 12px 0;">
                        <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üë§ –ó–∞–∫–∞–∑—á–∏–∫</div>
                        <div style="color: #c9d1d9; font-size: 13px;">${order.ownerName}</div>
                    </div>
                </div>

                <div style="margin-top: 16px; display: flex; gap: 8px; flex-direction: column;">
                    ${canBid ? `
                        <button class="btn btn-primary" onclick="submitBid(${orderId})">
                            üì§ –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è
                        </button>
                    ` : ''}
                    ${isOwner ? `
                        <button class="btn btn-secondary" onclick="deleteOrder(${orderId})">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    ` : ''}
                    ${!isOwner && !canBid ? `
                        <button class="btn btn-secondary" onclick="reportOrder(${orderId})">
                            ‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                        </button>
                    ` : ''}
                </div>
            `;

            document.getElementById('orderDetailBody').innerHTML = detailHTML;
            document.getElementById('orderDetailModal').classList.add('active');
        }

        function closeOrderDetail() {
            document.getElementById('orderDetailModal').classList.remove('active');
        }

        function toggleOrderMenu(event, orderId) {
            event.stopPropagation();
            const menu = document.getElementById(`menu-${orderId}`);
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function reportOrder(orderId) {
            closeOrderDetail();
            let reason = prompt(
                '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã:\n' +
                '1 - –ù–µ–ø–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏\n' +
                '2 - –ú–∞–ª–æ –ø–ª–∞—Ç—è—Ç\n' +
                '3 - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é'
            );

            if (reason === '1') {
                alert('‚úÖ –ñ–∞–ª–æ–±–∞ –Ω–∞ "–ù–µ–ø–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            } else if (reason === '2') {
                alert('‚úÖ –ñ–∞–ª–æ–±–∞ –Ω–∞ "–ú–∞–ª–æ –ø–ª–∞—Ç—è—Ç" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            } else if (reason === '3') {
                alert('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é');
            }
        }

        function deleteOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            // –£–¥–∞–ª—è–µ–º –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
            if (currentUser.orders) {
                currentUser.orders = currentUser.orders.filter(o => o.id !== orderId);
                saveUser(currentUser);
            }

            // –£–¥–∞–ª—è–µ–º –∏–∑ marketplace
            let allOrders = [];
            try {
                const stored = localStorage.getItem('all_orders');
                allOrders = stored ? JSON.parse(stored) : [];
            } catch (e) {}
            allOrders = allOrders.filter(o => o.id !== orderId);
            localStorage.setItem('all_orders', JSON.stringify(allOrders));

            closeOrderDetail();
            alert('‚úÖ –ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω');
            displayMarketplace();
        }

        function toggleMyOrderMenu(event, orderId) {
            event.stopPropagation();
            const menu = document.getElementById(`my-order-menu-${orderId}`);
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function deleteMyOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            // –£–¥–∞–ª—è–µ–º –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
            if (currentUser.orders) {
                currentUser.orders = currentUser.orders.filter(o => o.id !== orderId);
                saveUser(currentUser);
            }

            // –£–¥–∞–ª—è–µ–º –∏–∑ marketplace
            let allOrders = [];
            try {
                const stored = localStorage.getItem('all_orders');
                allOrders = stored ? JSON.parse(stored) : [];
            } catch (e) {}
            allOrders = allOrders.filter(o => o.id !== orderId);
            localStorage.setItem('all_orders', JSON.stringify(allOrders));

            alert('‚úÖ –ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω');
            displayMyOrders();
        }

        function toggleMyServiceMenu(event, serviceId) {
            event.stopPropagation();
            const menu = document.getElementById(`my-service-menu-${serviceId}`);
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function deleteMyService(serviceId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            // –£–¥–∞–ª—è–µ–º –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
            if (currentUser.services) {
                currentUser.services = currentUser.services.filter(s => s.id !== serviceId);
                saveUser(currentUser);
            }

            // –£–¥–∞–ª—è–µ–º –∏–∑ marketplace
            let allServices = [];
            try {
                const stored = localStorage.getItem('all_services');
                allServices = stored ? JSON.parse(stored) : [];
            } catch (e) {}
            allServices = allServices.filter(s => s.id !== serviceId);
            localStorage.setItem('all_services', JSON.stringify(allServices));

            alert('‚úÖ –£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
            displayMyServices();
        }

        function submitBid(orderId) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç–∫–ª–∏–∫–∞
            const bidFormHTML = `
                <div class="card">
                    <h3 style="color: #58a6ff; margin-bottom: 16px; font-size: 16px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫</h3>
                    
                    <div class="form-group">
                        <label>–í–∞—à–∞ —Ü–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type="number" id="bidPrice" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ü–µ–Ω—É" min="100" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–Ω–∏)</label>
                        <input type="number" id="bidDays" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</label>
                        <textarea id="bidMessage" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ—á–µ–º—É –≤—ã –ø–æ–¥—Ö–æ–¥–∏—Ç–µ –¥–ª—è —ç—Ç–æ–π —Ä–∞–±–æ—Ç—ã..." style="resize: vertical; min-height: 100px;"></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendBid(${orderId})">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫</button>
                    <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeOrderDetail()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            
            document.getElementById('orderDetailBody').innerHTML = bidFormHTML;
        }

        function sendBid(orderId) {
            const price = document.getElementById('bidPrice').value;
            const days = document.getElementById('bidDays').value;
            const message = document.getElementById('bidMessage').value;
            
            if (!price || !days || !message) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            alert(`‚úÖ –û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n\n–¶–µ–Ω–∞: ${price}‚ÇΩ\n–°—Ä–æ–∫: ${days} –¥–Ω.\n\n–ñ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞...`);
            closeOrderDetail();
        }

        function getCategoryName(categoryKey) {
            const categories = {
                'design': '–î–∏–∑–∞–π–Ω',
                'dev': '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞',
                'copywriting': '–ö–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥',
                'marketing': '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥',
                'seo': 'SEO',
                'translate': '–ü–µ—Ä–µ–≤–æ–¥',
                'video': '–í–∏–¥–µ–æ',
                'music': '–ú—É–∑—ã–∫–∞'
            };
            return categories[categoryKey] || categoryKey;
        }

        function openServiceDetail(serviceId) {
            let service = null;
            let allServices = [];
            try {
                const stored = localStorage.getItem('all_services');
                allServices = stored ? JSON.parse(stored) : [];
            } catch (e) {}

            service = allServices.find(s => s.id === serviceId);
            if (!service) return;

            const isOwner = service.ownerEmail === currentUser.email;
            const isClient = currentUser.accountType === 'client';

            let detailHTML = `
                <div class="card">
                    <h3 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px;">${service.name}</h3>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                        <div style="color: #c9d1d9; font-size: 13px; line-height: 1.5;">${service.description}</div>
                    </div>

                    <div class="divider"></div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0;">
                        <div>
                            <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üí∞ –¶–µ–Ω–∞</div>
                            <div style="color: #238636; font-weight: 600; font-size: 16px;">${service.price} ‚ÇΩ</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üìÖ –°—Ä–æ–∫</div>
                            <div style="color: #c9d1d9; font-size: 14px;">${service.days} –¥–Ω.</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                        <div style="color: #c9d1d9; font-size: 13px;">${getCategoryName(service.category)}</div>
                    </div>

                    <div class="divider"></div>

                    <div style="margin: 12px 0;">
                        <div style="font-size: 12px; color: #6e7681; margin-bottom: 4px;">üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</div>
                        <div style="color: #c9d1d9; font-size: 13px;">${service.ownerName}</div>
                    </div>
                </div>

                <div style="margin-top: 16px; display: flex; gap: 8px; flex-direction: column;">
                    ${isClient && !isOwner ? `
                        <button class="btn btn-primary" onclick="buyService('${serviceId}')">
                            üí≥ –ó–∞–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥—É
                        </button>
                    ` : ''}
                    ${isOwner ? `
                        <button class="btn btn-secondary" onclick="deleteService('${serviceId}')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É
                        </button>
                    ` : ''}
                    ${!isOwner ? `
                        <button class="btn btn-secondary" onclick="reportService('${serviceId}')">
                            ‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                        </button>
                    ` : ''}
                </div>
            `;

            document.getElementById('orderDetailBody').innerHTML = detailHTML;
            document.getElementById('orderDetailModal').classList.add('active');
        }

        function toggleServiceMenu(event, serviceId) {
            event.stopPropagation();
            const menu = document.getElementById(`service-menu-${serviceId}`);
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function reportService(serviceId) {
            closeOrderDetail();
            let reason = prompt(
                '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã:\n' +
                '1 - –ù–µ–ø–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É—Å–ª—É–≥–∏\n' +
                '2 - –ó–∞–≤—ã—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞\n' +
                '3 - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é'
            );

            if (reason === '1') {
                alert('‚úÖ –ñ–∞–ª–æ–±–∞ –Ω–∞ "–ù–µ–ø–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É—Å–ª—É–≥–∏" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            } else if (reason === '2') {
                alert('‚úÖ –ñ–∞–ª–æ–±–∞ –Ω–∞ "–ó–∞–≤—ã—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            } else if (reason === '3') {
                alert('‚úÖ –£—Å–ª—É–≥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é');
            }
        }

        function deleteService(serviceId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            let allServices = [];
            try {
                const stored = localStorage.getItem('all_services');
                allServices = stored ? JSON.parse(stored) : [];
            } catch (e) {}

            allServices = allServices.filter(s => s.id !== serviceId);
            localStorage.setItem('all_services', JSON.stringify(allServices));

            if (currentUser.services) {
                currentUser.services = currentUser.services.filter(s => s.id !== serviceId);
                saveUser(currentUser);
            }

            closeOrderDetail();
            alert('‚úÖ –£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
            displayMarketplace();
        }

        function buyService(serviceId) {
            const message = prompt('–ù–∞–ø–∏—à–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ OK:');
            if (message !== null) {
                alert('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ —É—Å–ª—É–≥—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é!');
                closeOrderDetail();
            }
        }

        function recoverPassword() {
            const email = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email:');
            if (email) {
                alert(`‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ ${email}`);
            }
        }

        function showLoadingStep(text) {
            const loadingText = document.querySelector('#loadingScreen .loading-text');
            if (loadingText) {
                loadingText.textContent = text;
                console.log(text); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
            }
        }

        async function initializeApp() {
            const loadingScreen = document.getElementById('loadingScreen');
            const INIT_TIMEOUT = 30000; // 30 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('–¢–∞–π–º–∞—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏')), INIT_TIMEOUT)
                );
                
                // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                const initPromise = (async () => {
                    if (!loadingScreen.classList.contains('hidden')) {
                        showLoadingStep('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
                        console.log('üìç [1/8] Connecting to server...');
                        
                        showLoadingStep('üë§ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π...');
                        console.log('üìç [2/8] Loading profiles...');
                        const stored = localStorage.getItem(STORAGE_KEY);
                        console.log('üìç Stored data:', !!stored);
                        
                        if (stored) {
                            const {email} = JSON.parse(stored);
                            console.log('üìç [3/8] Loading user:', email);
                            showLoadingStep('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
                            
                            const loaded = await loadUserFromServer(email);
                            console.log('üìç [4/8] User loaded:', !!loaded);
                            
                            if (loaded && currentUser) {
                                showLoadingStep('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...');
                                console.log('üìç [5/8] Syncing data...');
                                
                                showLoadingStep('üßπ –û—á–∏—Å—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...');
                                await cleanupDeletedItems();
                                console.log('üìç [6/8] Cleanup done...');
                                
                                showLoadingStep('üíæ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞...');
                                await loadAllOrdersFromServer();
                                await loadAllServicesFromServer();
                                console.log('üìç [7/8] Cache updated...');
                                
                                showLoadingStep('‚ú® –ì–æ—Ç–æ–≤–æ! –ó–∞–≥—Ä—É–∂–∞—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å...');
                                console.log('üìç [8/8] Finishing...');
                                
                                await new Promise(r => setTimeout(r, 300));
                                switchPage('homePage');
                                displayHome();
                            } else {
                                console.error('‚ùå Auth failed');
                                showLoadingStep('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                                await new Promise(r => setTimeout(r, 500));
                                switchPage('loginPage');
                            }
                        } else {
                            console.log('üìç No stored user, showing login');
                            showLoadingStep('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
                            await new Promise(r => setTimeout(r, 500));
                            switchPage('loginPage');
                        }
                    }
                })();
                
                // –ñ–¥–µ–º —á—Ç–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —Ä–∞–Ω—å—à–µ
                await Promise.race([initPromise, timeoutPromise]);
                
            } catch (e) {
                console.error('‚ùå Init error:', e);
                showLoadingStep('‚ö†Ô∏è –û—à–∏–±–∫–∞: ' + e.message);
                await new Promise(r => setTimeout(r, 2000));
                switchPage('loginPage');
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
            }
            document.body.classList.add('initialized');
            console.log('‚úÖ Initialization complete');
        }

        async function cleanupDeletedItems() {
            // –û—á–∏—â–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ –ë–î
            try {
                const response = await fetch('/api/users/all', { 
                    signal: AbortSignal.timeout(3000) 
                });
                if (response.ok) {
                    const allUsers = await response.json();
                    let validOrders = [];
                    let validServices = [];
                    
                    // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –∑–∞–∫–∞–∑—ã –∏ —É—Å–ª—É–≥–∏
                    Object.values(allUsers).forEach(user => {
                        if (user.orders && Array.isArray(user.orders)) {
                            validOrders.push(...user.orders);
                        }
                        if (user.services && Array.isArray(user.services)) {
                            validServices.push(...user.services);
                        }
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∏–∑ localStorage
                    const oldOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
                    const oldServices = JSON.parse(localStorage.getItem('all_services') || '[]');
                    
                    const newOrders = oldOrders.filter(o => validOrders.some(v => v.id === o.id));
                    const newServices = oldServices.filter(s => validServices.some(v => v.id === s.id));
                    
                    localStorage.setItem('all_orders', JSON.stringify(newOrders));
                    localStorage.setItem('all_services', JSON.stringify(newServices));
                }
            } catch (e) {
                console.log('–û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìç DOMContentLoaded fired');
            initializeApp().catch(e => {
                console.error('‚ö†Ô∏è Unhandled init error:', e);
            });
        });
        
        // Backup: –µ—Å–ª–∏ DOMContentLoaded –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞ 2 —Å–µ–∫
        setTimeout(() => {
            if (!document.body.classList.contains('initialized')) {
                console.warn('‚ö†Ô∏è DOMContentLoaded timeout, forcing init...');
                initializeApp().catch(e => console.error('Forced init error:', e));
            }
        }, 2000);
    </script>
</body>
</html>
